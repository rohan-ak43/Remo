<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Patient | Remote Physio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  background: #fff;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

h2 {
  color: #2a5298;
  margin-bottom: 20px;
  font-size: 2em;
}

.video-container {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  margin-bottom: 20px;
}

video, canvas {
  width: 100%;
  display: block;
  border-radius: 12px;
}

canvas {
  position: absolute;
  top: 0;
  left: 0;
}

.controls {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

button {
  padding: 12px 24px;
  border: none;
  background: #667eea;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  font-weight: 600;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
}

button:hover {
  background: #764ba2;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.stat-value {
  font-size: 2.5em;
  font-weight: bold;
  margin: 5px 0;
}

.stat-label {
  font-size: 0.9em;
  opacity: 0.9;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.ai-feedback-box {
  background: #f8f9fa;
  border-left: 4px solid #667eea;
  padding: 20px;
  border-radius: 8px;
  margin-top: 20px;
}

.ai-feedback-box h3 {
  color: #2a5298;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.feedback-content {
  color: #555;
  line-height: 1.6;
  font-size: 1.1em;
}

.status-message {
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-weight: 500;
}

.status-message.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.status-message.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.status-message.info {
  background: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

.chat-container {
  margin-top: 20px;
  border-top: 2px solid #eee;
  padding-top: 20px;
}

.chat-input-group {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.chat-input {
  flex: 1;
  padding: 12px;
  border: 2px solid #667eea;
  border-radius: 8px;
  font-size: 1em;
}

.chat-messages {
  max-height: 200px;
  overflow-y: auto;
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.chat-message {
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 8px;
}

.chat-message.user {
  background: #667eea;
  color: white;
  margin-left: 20px;
}

.chat-message.assistant {
  background: white;
  color: #333;
  margin-right: 20px;
  border: 1px solid #ddd;
}

.loading {
  display: inline-block;
  margin-left: 10px;
}

.loading:after {
  content: '...';
  animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60%, 100% { content: '...'; }
}

.tip-badge {
  display: inline-block;
  background: #ffc107;
  color: #333;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.9em;
  margin-top: 10px;
}
</style>
</head>

<body>
<div class="container">
  <h2>üèãÔ∏è Patient Rehabilitation Session</h2>

  <div id="statusMessage" class="status-message info">
    Ready to begin your rehabilitation session
  </div>

  <div class="video-container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="controls">
    <button id="startBtn">
      <span>üìπ</span> Start Camera
    </button>
    <button id="stopBtn" disabled>
      <span>‚èπÔ∏è</span> Stop Camera
    </button>
    <button id="getFeedbackBtn" disabled>
      <span>ü§ñ</span> Get AI Feedback
    </button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="repCount">0</div>
      <div class="stat-label">Reps Completed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="formScore">0%</div>
      <div class="stat-label">Form Accuracy</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="sessionTime">0:00</div>
      <div class="stat-label">Session Time</div>
    </div>
  </div>

  <div class="ai-feedback-box" id="aiFeedbackBox" style="display: none;">
    <h3>ü§ñ AI Coach Feedback</h3>
    <div class="feedback-content" id="feedbackContent">
      Waiting for feedback...
    </div>
  </div>

  <div class="chat-container">
    <h3>üí¨ Ask Your AI Assistant</h3>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-group">
      <input 
        type="text" 
        class="chat-input" 
        id="chatInput" 
        placeholder="Ask about your exercise, pain, or technique..."
        disabled
      />
      <button id="sendChatBtn" disabled>
        <span>üì§</span> Send
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose_connections.js"></script>

<script>
const API_URL = window.location.origin;
const socket = io(API_URL);

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusMessageEl = document.getElementById("statusMessage");
const repEl = document.getElementById("repCount");
const formScoreEl = document.getElementById("formScore");
const sessionTimeEl = document.getElementById("sessionTime");
const aiFeedbackBox = document.getElementById("aiFeedbackBox");
const feedbackContent = document.getElementById("feedbackContent");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const getFeedbackBtn = document.getElementById("getFeedbackBtn");
const sendChatBtn = document.getElementById("sendChatBtn");

let pose, camera;
let repCount = 0;
let armUp = false;
let formScore = 0;
let sessionStartTime = null;
let sessionTimerInterval = null;
let isSessionActive = false;
let lastElbowAngle = 0;

function showStatus(message, type = 'info') {
  statusMessageEl.textContent = message;
  statusMessageEl.className = `status-message ${type}`;
}

function updateSessionTimer() {
  if (!sessionStartTime) return;
  
  const elapsed = Date.now() - sessionStartTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  sessionTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function calculateFormAccuracy(angle, shoulderY, elbowY, wristY) {
  let accuracy = 100;
  
  // Check elbow angle (optimal range: 30-170 degrees)
  if (angle < 30 || angle > 170) {
    accuracy -= 20;
  }
  
  // Check if elbow is stable (not swinging)
  const elbowStability = Math.abs(elbowY - shoulderY);
  if (elbowStability > 0.1) {
    accuracy -= 15;
  }
  
  // Check wrist alignment
  const wristAlignment = Math.abs(wristY - elbowY);
  if (wristAlignment > 0.15) {
    accuracy -= 15;
  }
  
  return Math.max(0, Math.min(100, accuracy));
}

function onResults(results) {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.save();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
  
  if (results.poseLandmarks) {
    drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {
      color: '#00FF00',
      lineWidth: 4
    });
    drawLandmarks(ctx, results.poseLandmarks, {
      color: '#FF0000',
      lineWidth: 2,
      radius: 6
    });

    const lm = results.poseLandmarks;
    const shoulder = lm[11];
    const elbow = lm[13];
    const wrist = lm[15];
    
    if (shoulder && elbow && wrist) { // Check for landmarks
        const angle = calcAngle(shoulder, elbow, wrist);
        lastElbowAngle = angle;
        
        // Calculate form accuracy
        formScore = calculateFormAccuracy(angle, shoulder.y, elbow.y, wrist.y);
        formScoreEl.textContent = formScore + '%';
        
        // Display angle on canvas
        ctx.fillStyle = 'white';
        ctx.font = 'bold 24px Arial';
        ctx.fillText(`Angle: ${Math.round(angle)}¬∞`, 20, 40);
        ctx.fillText(`Form: ${formScore}%`, 20, 70);

        // Rep counting logic
        if (angle < 50 && !armUp) {
          armUp = true;
        }
        if (angle > 160 && armUp) {
          repCount++;
          repEl.textContent = repCount;
          armUp = false;

          // Send update to doctor via WebSocket
          socket.emit("cv-update", {
            reps: repCount,
            formAccuracy: formScore,
            timestamp: Date.now()
          });
          
          console.log("‚úÖ Rep completed:", repCount);
          showStatus(`Great! Rep ${repCount} completed with ${formScore}% form accuracy`, 'success');
          
          // Auto-feedback every 5 reps
          if (repCount % 5 === 0) {
            getAIFeedback();
          }
        }
    }
  }

  ctx.restore();
}

function calcAngle(a, b, c) {
  const AB = Math.atan2(c.y - b.y, c.x - b.x);
  const BC = Math.atan2(a.y - b.y, a.x - b.x);
  let angle = Math.abs(AB - BC) * 180 / Math.PI;
  if (angle > 180) angle = 360 - angle;
  return angle;
}

async function getAIFeedback() {
  getFeedbackBtn.disabled = true;
  getFeedbackBtn.innerHTML = '<span class="loading">Getting feedback</span>';
  
  try {
    const response = await fetch(`${API_URL}/gemini/analyze-form-quick`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        poseData: {
          reps: repCount,
          formAccuracy: formScore,
          elbowAngle: lastElbowAngle
        }
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      aiFeedbackBox.style.display = 'block';
      feedbackContent.innerHTML = `
        <p>${data.feedback}</p>
        <div class="tip-badge">üí° Keep up the great work!</div>
      `;
    }
  } catch (error) {
    console.error('Error getting AI feedback:', error);
    showStatus('Failed to get AI feedback. Continue your exercise.', 'error');
  } finally {
    getFeedbackBtn.disabled = false;
    getFeedbackBtn.innerHTML = '<span>ü§ñ</span> Get AI Feedback';
  }
}

async function sendChatMessage() {
  const message = chatInput.value.trim();
  if (!message) return;
  
  // Display user message
  const userMsg = document.createElement('div');
  userMsg.className = 'chat-message user';
  userMsg.textContent = message;
  chatMessages.appendChild(userMsg);
  
  chatInput.value = '';
  chatInput.disabled = true;
  sendChatBtn.disabled = true;
  
  try {
    const response = await fetch(`${API_URL}/gemini/chat`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        sessionContext: {
          reps: repCount,
          formAccuracy: formScore,
          active: isSessionActive
        }
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      const assistantMsg = document.createElement('div');
      assistantMsg.className = 'chat-message assistant';
      assistantMsg.textContent = data.response;
      chatMessages.appendChild(assistantMsg);
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  } catch (error) {
    console.error('Error sending chat message:', error);
    const errorMsg = document.createElement('div');
    errorMsg.className = 'chat-message assistant';
    errorMsg.textContent = 'Sorry, I had trouble responding. Please try again.';
    chatMessages.appendChild(errorMsg);
  } finally {
    chatInput.disabled = false;
    sendChatBtn.disabled = false;
    chatInput.focus();
  }
}

startBtn.onclick = async () => {
  try {
    showStatus('Initializing camera and pose detection...', 'info');
    
    pose = new Pose({
      locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
    });

    pose.setOptions({
      modelComplexity: 1,
      minTrackingConfidence: 0.5,
      minDetectionConfidence: 0.5,
      smoothLandmarks: true
    });

    pose.onResults(onResults);

    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 1280, 
        height: 720 
      } 
    });
    video.srcObject = stream;

    // Wait for video to be ready
    await new Promise((resolve) => {
        video.onloadedmetadata = () => {
            resolve();
        };
    });

    camera = new Camera(video, {
      onFrame: async () => await pose.send({ image: video }),
      width: video.videoWidth,
      height: video.videoHeight
    });

    await camera.start();
    
    sessionStartTime = Date.now();
    isSessionActive = true;
    sessionTimerInterval = setInterval(updateSessionTimer, 1000);
    
    showStatus('Camera started! Begin your bicep curls when ready.', 'success');
    startBtn.disabled = true;
    stopBtn.disabled = false;
    getFeedbackBtn.disabled = false;
    chatInput.disabled = false;
    sendChatBtn.disabled = false;

  } catch (e) {
    showStatus('Camera error: ' + e.message, 'error');
    console.error('Camera error:', e);
  }
};

stopBtn.onclick = () => {
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
  }
  if (camera) camera.stop();
  if (sessionTimerInterval) clearInterval(sessionTimerInterval);
  
  isSessionActive = false;
  showStatus('Session ended. Great work!', 'info');
  stopBtn.disabled = true;
  startBtn.disabled = false;
  getFeedbackBtn.disabled = true;
  chatInput.disabled = true;
  sendChatBtn.disabled = true;
};

getFeedbackBtn.onclick = getAIFeedback;

sendChatBtn.onclick = sendChatMessage;

chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendChatMessage();
  }
});

// Socket.IO connection status
socket.on('connect', () => {
  console.log('‚úÖ Connected to server');
});

socket.on('disconnect', () => {
  console.log('‚ùå Disconnected from server');
});

// Initial welcome message
const welcomeMsg = document.createElement('div');
welcomeMsg.className = 'chat-message assistant';
welcomeMsg.textContent = 'Hello! I\'m your AI rehabilitation assistant. Feel free to ask me questions about your exercise, any discomfort you\'re experiencing, or technique tips!';
chatMessages.appendChild(welcomeMsg);
</script>
</body>
</html>